# The Apple M1

Historically our dev workflows and setup have revolved around x86 architecture. The M1 is 
new and can be a bit of a problem setting up. As you work through this process, please update
this doc with quirks, tricks, or best practices you come across.

!!! warning

    As of the commit of this documentation, the following blog is the best place to start. Forge your own path at your
    and your colleagues risk. Right now it is very easy to get into a state where confusing things happen.

Colin's blog post [Python, Django, and React Development on Apple Silicon](https://www.caktusgroup.com/blog/2021/04/02/python-django-react-development-apple-silicon/ "Python Django React Apple Silicon").

## Environment setup


### Rosetta 2 and Xcode

First, make sure Rosetta 2 is installed. [Rosetta 2](https://support.apple.com/en-us/HT211861) enables a Mac with Apple silicon to use apps built for a Mac with an Intel processor. Install it with:

```shell
softwareupdate --install-rosetta  --agree-to-license
```

Also, install Xcode's command-line tools for `python3` and other useful libraries:

```shell
xcode-select --install
```


### Generating a new SSH key

Follow GitHub's [Generating a new SSH key and adding it to the ssh-agent](https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent) instructions for these sections:

  * Generating a new SSH key
  * Adding your SSH key to the ssh-agent


### Homebrew

Homebrew does [support Apple Silicon](https://brew.sh/2020/12/01/homebrew-2.6.0/). However, a particular package may not run natively, so your mileage may vary. To support running both native arm64 and x86-emulated homebrew packages, you install them side-by-side.

Install arm64 ``brew`` into ``/opt/homebrew``:

```shell
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
```

Then add `brew` to your PATH:

```shell
echo 'export PATH="/opt/homebrew/bin:$PATH"' >> ~/.zshrc
```


### Starship Prompt

Starship is a simple and customizable shell prompt. Follow the [Quick Install](https://starship.rs/#quick-install) instructions to get set up.


!!! note
    
    Make sure to install a [Nerd Font](https://www.nerdfonts.com/font-downloads) to render 
    glyph symbols (:octicons-repo-forked-16:, :material-snake:) properly. Then enable the font
    in your terminal:

    - **iTerm2**: Open *iTerm2 → Preferences → Profiles → Text* and set *Font* to your Nerd Font.
    - **Visual Studio Code**: Open *Code → Preferences → Settings* (Mac), enter `terminal.integrated.fontFamily` in the search box at the top of *Settings* ta and set the value below to your Nerd Font.


### direnv

Next install [direnv](https://direnv.net/), which will load/unload environment variables based on a `.envrc` file.

```shell
brew install direnv
```

Add the following line to your `~/.zshrc`:

```shell
eval "$(direnv hook zsh)"
```

   ### A. Streamlined version of Colin's article here)
   ### B. `.zshrc` modifications (handles brew and nvm issues).
   ### C. Starship config `xarch` (architecture switching function in .toml).
   ### D. VSCode setup.

### 2. Project setup
   ### A. Instructions on `direnv` virtual environment setup for any given project.
   ### B. Document how this is handled in `Jade Truffle` and linked here for all M1 users.
   
   TBD any additional issues that may arise from containers or aws services.
        
        
## Currently Identified Additions to .zshrc for M1 Users


```shell
alias ibrew='arch -x86_64 /usr/local/bin/brew'

export NVM_DIR="$HOME/.nvm"
[ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && . "/opt/homebrew/opt/nvm/nvm.sh"  # This loads nvm
[ -s "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm" ] && . "/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm"  # This loads nvm bash_completion

autoload -U add-zsh-hook
load-nvmrc() {
  local node_version="$(nvm version)"
  local nvmrc_path="$(nvm_find_nvmrc)"

  if [ -n "$nvmrc_path" ]; then
    local nvmrc_node_version=$(nvm version "$(cat "${nvmrc_path}")")

    if [ "$nvmrc_node_version" = "N/A" ]; then
      nvm install
    elif [ "$nvmrc_node_version" != "$node_version" ]; then
      nvm use
    fi
  elif [ "$node_version" != "$(nvm version default)" ]; then
    echo "Reverting to nvm default version"
    nvm use default
  fi
}
add-zsh-hook chpwd load-nvmrc
load-nvmrc

# Add homebrew to path
export PATH="/opt/homebrew/bin:$PATH"

# C-lib complication flags
export LDFLAGS="-L$(brew --prefix openssl)/lib -L$(brew --prefix zlib)/lib"
export CPPFLAGS="-I$(brew --prefix openssl)/include -I$(brew --prefix zlib)/include"

# Hook in direnv
eval "$(direnv hook zsh)"

eval "$(pyenv init -)"
```
